#!/bin/bash
# alerter - macOS notification wrapper
# Uses terminal-notifier when available (supports icons), falls back to osascript

set -euo pipefail

title=""
message=""
sound=""
app_icon=""
sender=""
group=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -title)
            title="$2"
            shift 2
            ;;
        -message)
            message="$2"
            shift 2
            ;;
        -sound)
            sound="$2"
            shift 2
            ;;
        -appIcon)
            app_icon="$2"
            shift 2
            ;;
        -sender)
            sender="$2"
            shift 2
            ;;
        -group)
            group="$2"
            shift 2
            ;;
        -timeout|-contentImage|-actions|-closeLabel|-dropdownLabel|-reply)
            # Skip these arguments
            shift 2
            ;;
        -help|--help)
            echo "alerter - macOS notification wrapper"
            echo "Usage: alerter -message VALUE [-title VALUE] [-sound VALUE] [-appIcon PATH]"
            echo ""
            echo "Options:"
            echo "  -message VALUE    The notification message (required)"
            echo "  -title VALUE      The notification title"
            echo "  -sound VALUE      Sound to play (e.g., 'default', 'Ping', 'Pop')"
            echo "  -appIcon PATH     Path to icon image (requires terminal-notifier)"
            echo "  -sender ID        Bundle ID for notification icon"
            echo "  -group ID         Group ID for notification grouping"
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

if [[ -z "$message" ]]; then
    echo "Error: -message is required" >&2
    exit 1
fi

# Use terminal-notifier if available (supports icons and more features)
if command -v terminal-notifier &>/dev/null; then
    args=(-message "$message")
    [[ -n "$title" ]] && args+=(-title "$title")
    [[ -n "$sound" ]] && args+=(-sound "$sound")
    [[ -n "$app_icon" ]] && args+=(-contentImage "$app_icon")
    [[ -n "$sender" ]] && args+=(-sender "$sender")
    [[ -n "$group" ]] && args+=(-group "$group")
    terminal-notifier "${args[@]}"
else
    # Fall back to osascript (no icon support)
    escape_for_applescript() {
        printf '%s' "$1" | sed 's/\\/\\\\/g; s/"/\\"/g'
    }

    message_escaped=$(escape_for_applescript "$message")
    title_escaped=$(escape_for_applescript "$title")
    sound_escaped=$(escape_for_applescript "$sound")

    script="display notification \"$message_escaped\""
    [[ -n "$title" ]] && script="$script with title \"$title_escaped\""
    [[ -n "$sound" ]] && script="$script sound name \"$sound_escaped\""

    osascript -e "$script"
fi
