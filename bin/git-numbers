#!/usr/bin/python3
################################################################################
# Git Numbers - Diff Summary Statistics
#
# DESCRIPTION:
#   Analyzes git diffs and prints summary statistics: total diff lines,
#   lines added/removed, and words added/removed. Useful for quickly
#   understanding the size and scope of changes.
#
# USAGE:
#   git diff [options] | git-numbers
#   git-numbers <diff-file>
#
# EXAMPLES:
#   git diff 'main~10..main' | git-numbers
#   git diff --cached | git-numbers           # Check staged changes
#   git show HEAD | git-numbers               # Analyze last commit
#   git-numbers my-awesome-patch.diff         # Analyze a diff file
#
# OUTPUT:
#   293 lines of diff
#   +185 lines (+200, -15)
#   +10 words (+660, -650)
#
# NOTES:
#   - Line counts exclude diff metadata (+++, --- markers)
#   - Word counts only include words matching \w+ pattern
#   - Reads from stdin or file argument
#
################################################################################

import sys, os, re, fileinput

def get_lines(diff_lines):
    # Added lines start with '+' (but not '+++', because that marks a new
    # file).  The same goes for removed lines, except '-' instead of '+'.
    added_lines = [line for line in diff_lines
        if line.startswith('+') and not line.startswith('+++')]
    removed_lines = [line for line in diff_lines
        if line.startswith('-') and not line.startswith('---')]
    return added_lines, removed_lines

def get_words(added_lines, removed_lines):
    def word_count(lines):
        return [word
                for line in lines
                for word in line.split()
                if re.match(r'^\w+', word)]

    return word_count(added_lines), word_count(removed_lines)

if __name__ == '__main__':
    diff_lines = list(fileinput.input())
    added_lines, removed_lines = get_lines(diff_lines)
    added_words, removed_words = get_words(added_lines, removed_lines)
    print('%i lines of diff' % len(diff_lines))
    print('%+i lines (+%i, -%i)' % (len(added_lines) - len(removed_lines),
                                    len(added_lines),
                                    len(removed_lines)))
    print('%+i words (+%i, -%i)' % (len(added_words) - len(removed_words),
                                    len(added_words),
                                    len(removed_words)))
