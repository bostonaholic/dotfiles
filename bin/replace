#!/bin/bash
################################################################################
# Replace - Find and Replace Text in Files
#
# DESCRIPTION:
#   Finds all occurrences of a pattern in specified files and replaces them
#   with a new string. Uses fast search tools (ripgrep, ag, or grep) to find
#   files, then performs in-place replacement with sed.
#
# USAGE:
#   replace <find> <replace> <files...>
#
# ARGUMENTS:
#   find     - String or pattern to search for
#   replace  - String to replace it with
#   files    - File patterns to search (supports glob expansion)
#
# EXAMPLES:
#   replace foo bar **/*.rb          # Replace foo with bar in Ruby files
#   replace old_name new_name *.js   # Rename variable in JS files
#   replace http https **/*.md       # Update URLs in markdown files
#
# BEHAVIOR:
#   1. Uses ripgrep (rg), the silver searcher (ag), or grep to find files
#   2. For each file containing the pattern, runs sed to replace
#   3. Creates temp file, replaces content, then moves back
#
# NOTES:
#   - Performs literal string replacement (not regex by default)
#   - Modifies files in-place (no backup created)
#   - Uses fastest available search tool (rg > ag > grep)
#
# SOURCE:
#   https://github.com/thoughtbot/dotfiles/blob/master/bin/replace
#
################################################################################

set -euo pipefail

find_this="$1"
shift
replace_with="$1"
shift

if command -v rg &>/dev/null ; then
  items=$(rg -l --color never "$find_this" "$@")
elif command -v ag &>/dev/null ; then
  items=$(ag --files-with-matches --nocolor "$find_this" "$@")
else
  items=$(grep --files-with-matches "$find_this" "$@")
fi

temp="${TMPDIR:-/tmp}/replace_temp_file.$$"
trap 'rm -f "$temp"' EXIT
# shellcheck disable=SC2016 # Literal $ in sed character class is intentional
escaped_find=$(printf '%s\n' "$find_this" | sed 's/[[\.*^$()+?{|/]/\\&/g')
escaped_replace=$(printf '%s\n' "$replace_with" | sed 's/[&/\]/\\&/g')

IFS=$'\n'
for item in $items; do
  sed "s/${escaped_find}/${escaped_replace}/g" "$item" > "$temp" && mv "$temp" "$item"
done
