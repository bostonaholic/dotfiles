#!/bin/bash
################################################################################
# Run Command on Git Revisions
#
# DESCRIPTION:
#   Runs a command on each commit in a git revision range. Useful for testing
#   when a bug was introduced or verifying tests pass across a series of commits.
#
# USAGE:
#   run-command-on-git-revisions [-v] <start-ref> <end-ref> <command>
#
# OPTIONS:
#   -v  - Verbose mode (shows detailed output)
#
# ARGUMENTS:
#   start-ref  - Starting git reference (exclusive)
#   end-ref    - Ending git reference (inclusive)
#   command    - Command to run on each revision
#
# EXAMPLES:
#   run-command-on-git-revisions origin/main main 'python runtests.py'
#   run-command-on-git-revisions HEAD~10 HEAD 'make test'
#   run-command-on-git-revisions -v main feature 'npm test'
#
# WARNING:
#   - Checks out past revisions! Save or stash uncommitted changes first
#   - Runs 'git reset --hard' after each command
#   - Be careful with untracked files in your working tree
#
# BEHAVIOR:
#   1. Gets list of revisions from start to end (oldest to newest)
#   2. For each revision: checkout, run command, reset hard
#   3. Returns to end_ref when complete
#
# SOURCE:
#   Gary Bernhardt's dotfiles
#   https://github.com/garybernhardt/dotfiles
#
################################################################################

set -eux -o pipefail

if [[ $1 == -v ]]; then
    verbose=1
    shift
fi
start_ref=$1
end_ref=$2
test_command=$3

main() {
    enforce_usage
    run_tests
}

enforce_usage() {
    if [ -z "$test_command" ]; then
        usage
        exit "$E_BADARGS"
    fi
}

usage() {
    echo "usage: $(basename "$0") start_ref end_ref test_command"
}

run_tests() {
    revs=$(log_command git rev-list --reverse "${start_ref}".."${end_ref}")

    for rev in $revs; do
        debug "Checking out: $(git log --oneline -1 "$rev")"
        log_command git checkout --quiet "$rev"
        log_command "$test_command"
        log_command git reset --hard
    done
    log_command git checkout --quiet "$end_ref"
    debug "OK for all revisions!"
}

log_command() {
    debug "=> $*"
    eval "$*"
}

debug() {
    if [ "$verbose" ]; then
        echo "$*" >&2
    fi
}

main
