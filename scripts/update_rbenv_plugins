#!/bin/bash
################################################################################
# Update rbenv Plugins
#
# DESCRIPTION:
#   Updates all installed rbenv plugins by pulling latest changes from git.
#   Iterates through all plugins in rbenv plugins directory.
#
# USAGE:
#   Called by update.sh, or run directly:
#   ./update_rbenv_plugins
#
# WHAT IT DOES:
#   1. Checks if rbenv is installed, skips if not found
#   2. Finds all plugins in $RBENV_ROOT/plugins directory
#   3. For each plugin with a .git directory, runs 'git pull'
#   4. Reports which plugins were updated
#
# DEPENDENCIES:
#   - rbenv (skips if not installed)
#   - git (for updating repositories)
#   - Internet connection
#
# NOTES:
#   Only updates plugins that are git repositories.
#   Safe to run even if no plugins are installed.
#
################################################################################

set -euo pipefail

# Colors for output
readonly BLUE='\033[0;34m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[0;33m'
readonly NC='\033[0m'

# Logging functions
log() { echo -e "${BLUE}[INFO]${NC}  $1"; }
success() { echo -e "${GREEN}[DONE]${NC}  $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC}  $1"; }

# Main function
main() {
    if ! command -v rbenv &> /dev/null; then
        warn "rbenv not installed, skipping plugin updates"
        return
    fi

    log "Updating rbenv plugins..."
    RBENV_ROOT="${RBENV_ROOT:-$HOME/.rbenv}"

    if [[ -d "$RBENV_ROOT/plugins" ]]; then
        for plugin in "$RBENV_ROOT"/plugins/*; do
            if [[ -d "$plugin/.git" ]]; then
                plugin_name=$(basename "$plugin")
                log "Updating rbenv plugin: $plugin_name"
                (
                    cd "$plugin" || exit
                    git pull --quiet
                )
            fi
        done
        success "rbenv plugins updated"
    else
        warn "No rbenv plugins found"
    fi
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi