#!/bin/bash
################################################################################
# Install Homebrew and Packages
#
# DESCRIPTION:
#   Installs Homebrew package manager if not present, then installs all
#   packages defined in the Brewfile using brew bundle.
#
# USAGE:
#   Called by install.sh, or run directly:
#   ./install_homebrew
#
# ENVIRONMENT VARIABLES:
#   DRY_RUN  - If true, preview changes without making them (default: false)
#   VERBOSE  - If true, show detailed output (default: false)
#
# WHAT IT DOES:
#   1. Checks if Homebrew is installed, installs it if missing
#   2. Adds Homebrew to PATH for current session
#   3. Runs 'brew bundle' from Brewfile to install all packages
#
# DEPENDENCIES:
#   - Internet connection (to download Homebrew and packages)
#   - Brewfile in dotfiles directory
#
# NOTES:
#   Installation can take several minutes depending on number of packages
#   and internet speed.
#
################################################################################

set -euo pipefail

# shellcheck source=lib.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/lib.sh"

# Main function
main() {
    log "Installing Homebrew packages..."

    # Install Homebrew if not present
    if ! command -v brew &> /dev/null; then
        if [[ $DRY_RUN == true ]]; then
            log "[DRY RUN] Would install Homebrew"
        else
            log "Homebrew not found. Installing Homebrew..."
            log "This may take a few minutes..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

            # Add Homebrew to PATH for this session
            if [[ -x "/opt/homebrew/bin/brew" ]]; then
                eval "$(/opt/homebrew/bin/brew shellenv)"
            elif [[ -x "/usr/local/bin/brew" ]]; then
                eval "$(/usr/local/bin/brew shellenv)"
            fi

            success "Homebrew installed successfully"
        fi
    else
        log "Homebrew is already installed"
    fi

    # Install from Brewfile
    if [[ -f "$DOTFILES_DIR/Brewfile" ]]; then
        log "Found Brewfile at: $DOTFILES_DIR/Brewfile"
        if [[ $DRY_RUN == true ]]; then
            log "[DRY RUN] Would run: brew bundle"
            log "[DRY RUN] Would install packages from Brewfile"
        else
            log "Installing packages from Brewfile..."
            log "This may take several minutes depending on your internet connection..."
            cd "$DOTFILES_DIR"
            brew bundle
        fi
    else
        warn "Brewfile not found at: $DOTFILES_DIR/Brewfile"
        warn "Skipping Homebrew package installation"
    fi

    success "Homebrew package installation completed"
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi