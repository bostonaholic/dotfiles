#!/bin/bash
################################################################################
# Create Directories
#
# DESCRIPTION:
#   Creates directory structure specified in dotfiles.yaml. Ensures all
#   required directories exist before symlinks are created.
#
# USAGE:
#   Called by install.sh, or run directly:
#   ./install_directories
#
# ENVIRONMENT VARIABLES:
#   DRY_RUN  - If true, preview changes without making them (default: false)
#   VERBOSE  - If true, show detailed output (default: false)
#
# WHAT IT DOES:
#   1. Reads directory list from 'directories' key in dotfiles.yaml
#   2. Expands ~ and environment variables in paths
#   3. Creates each directory using 'mkdir -p'
#   4. Reports statistics on directories created vs. already existing
#
# DEPENDENCIES:
#   - yq (for parsing YAML)
#   - dotfiles.yaml configuration file
#
# NOTES:
#   This script is idempotent - safe to run multiple times.
#
################################################################################

set -euo pipefail

# shellcheck source=lib.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/lib.sh"

# Main function
main() {
    log "Creating directories..."

    # Use yq to parse directories from YAML
    debug "Reading directories from $CONFIG_FILE"
    local dirs
    dirs=$(yq eval '.directories[]' "$CONFIG_FILE" 2>/dev/null | sed "s|~|$HOME|g")

    local created=0
    local skipped=0
    local total=0

    if [[ -z "$dirs" ]]; then
        warn "No directories found in configuration"
        return
    fi

    while IFS= read -r dir; do
        if [[ -n "$dir" ]]; then
            total=$((total + 1))
            dir=$(eval echo "$dir")  # Expand variables
            if [[ ! -d "$dir" ]]; then
                if [[ $DRY_RUN == true ]]; then
                    log "[DRY RUN] Would create directory: $dir"
                else
                    log "Creating directory: $dir"
                    mkdir -p "$dir"
                    created=$((created + 1))
                fi
            else
                debug "Directory already exists: $dir"
                skipped=$((skipped + 1))
            fi
        fi
    done <<< "$dirs"

    if [[ $total -eq 0 ]]; then
        log "No directories to process"
    elif [[ $DRY_RUN == false ]]; then
        success "Directories created: $created new, $skipped already existed (total: $total)"
    else
        success "Directories checked: $total directories would be processed"
    fi
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi