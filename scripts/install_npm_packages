#!/bin/bash
################################################################################
# Install NPM Global Packages
#
# DESCRIPTION:
#   Installs global npm packages listed in dotfiles.yaml configuration.
#   Rehashes nodenv after installation if nodenv is being used.
#
# USAGE:
#   Called by install.sh, or run directly:
#   ./install_npm_packages
#
# ENVIRONMENT VARIABLES:
#   DRY_RUN  - If true, preview changes without making them (default: false)
#   VERBOSE  - If true, show detailed output (default: false)
#
# WHAT IT DOES:
#   1. Checks if npm is installed, skips if not found
#   2. Reads package list from packages.npm.global_packages in dotfiles.yaml
#   3. Installs each package globally using 'npm install -g'
#   4. Rehashes nodenv if it's installed
#   5. Reports statistics on packages installed
#
# DEPENDENCIES:
#   - npm (skips if not installed)
#   - yq (for parsing YAML)
#   - dotfiles.yaml configuration file
#   - Optional: nodenv
#
################################################################################

set -euo pipefail

# shellcheck source=lib.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/lib.sh"

# Main function
main() {
    log "Installing npm packages..."

    # Check if npm is available
    if ! command -v npm &> /dev/null; then
        warn "npm not found. Skipping npm package installation"
        warn "Install Node.js/npm first, then run: $0"
        return
    fi

    log "npm version: $(npm --version)"

    # Parse npm packages from YAML using yq
    local packages
    packages=$(yq eval '.packages.npm.global_packages[]' "$CONFIG_FILE" 2>/dev/null | tr -d '"')

    local installed=0
    local total=0

    while IFS= read -r package; do
        if [[ -n "$package" ]]; then
            total=$((total + 1))
            if [[ $DRY_RUN == true ]]; then
                log "[DRY RUN] Would install npm package: $package"
            else
                log "Installing npm package: $package"
                if npm install -g "$package"; then
                    installed=$((installed + 1))
                    success "  ✓ $package installed"
                else
                    warn "  ✗ Failed to install $package"
                fi
            fi
        fi
    done <<< "$packages"

    # Rehash if using nodenv
    if command -v nodenv &> /dev/null && [[ $DRY_RUN == false ]]; then
        log "Rehashing nodenv..."
        nodenv rehash
    fi

    if [[ $DRY_RUN == false ]]; then
        success "npm packages installed: $installed/$total packages"
    else
        success "npm packages checked: $total packages would be installed"
    fi
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi