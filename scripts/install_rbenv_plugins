#!/bin/bash
################################################################################
# Install rbenv Plugins
#
# DESCRIPTION:
#   Installs useful rbenv plugins for Ruby version management.
#   Clones plugin repositories into rbenv plugins directory.
#
# USAGE:
#   Called by install.sh, or run directly:
#   ./install_rbenv_plugins
#
# ENVIRONMENT VARIABLES:
#   DRY_RUN  - If true, preview changes without making them (default: false)
#   VERBOSE  - If true, show detailed output (default: false)
#
# PLUGINS INSTALLED:
#   - rbenv-default-gems: Automatically installs gems when installing new Ruby
#   - rbenv-ctags: Generates ctags for installed Ruby versions
#
# WHAT IT DOES:
#   1. Creates plugins directory in rbenv root if needed
#   2. Clones each plugin from GitHub (only if not already present)
#   3. Runs 'rbenv rehash' to make plugins available
#
# DEPENDENCIES:
#   - rbenv (must be installed)
#   - git (for cloning repositories)
#   - Internet connection
#
# NOTES:
#   Plugins are cloned via SSH (git@github.com). Ensure SSH keys are set up.
#
################################################################################

set -euo pipefail

# shellcheck source=lib.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/lib.sh"

main() {
    log "Installing rbenv plugins..."

    RBENV_ROOT="${RBENV_ROOT:-$HOME/.rbenv}"

    if [[ $DRY_RUN == false ]]; then
        mkdir -p "$RBENV_ROOT/plugins"
    fi

    local plugins=(
        'rbenv/rbenv-default-gems'
        'tpope/rbenv-ctags'
    )

    for plugin in "${plugins[@]}"; do
        local plugin_name plugin_repo
        plugin_name=$(echo "$plugin" | cut -d '/' -f 2)
        plugin_repo="git@github.com:${plugin}.git"

        if [[ -d "$RBENV_ROOT/plugins/$plugin_name" ]]; then
            debug "$plugin_name already installed"
            continue
        fi

        if [[ $DRY_RUN == true ]]; then
            log "[DRY RUN] Would install rbenv plugin: $plugin_name"
        else
            log "Installing rbenv plugin: $plugin_name"
            git clone "$plugin_repo" "$RBENV_ROOT/plugins/$plugin_name"
        fi
    done

    if [[ $DRY_RUN == false ]]; then
        rbenv rehash
    fi

    success "rbenv plugins installed"
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
