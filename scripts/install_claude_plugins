#!/bin/bash
################################################################################
# Install Claude Code Plugins
#
# DESCRIPTION:
#   Installs Claude Code plugins listed in dotfiles.yaml configuration.
#
# USAGE:
#   Called by install.sh, or run directly:
#   ./install_claude_plugins
#
# ENVIRONMENT VARIABLES:
#   DRY_RUN  - If true, preview changes without making them (default: false)
#   VERBOSE  - If true, show detailed output (default: false)
#
# WHAT IT DOES:
#   1. Checks if claude CLI is installed, skips if not found
#   2. Updates marketplace metadata to get latest plugin versions
#   3. Reads plugin list from packages.claude.plugins in dotfiles.yaml
#   4. Installs each plugin using 'claude plugin install'
#   5. Reports statistics on plugins installed
#
# DEPENDENCIES:
#   - claude CLI (skips if not installed)
#   - yq (for parsing YAML)
#   - dotfiles.yaml configuration file
#
# TROUBLESHOOTING:
#   Plugin install fails:
#     - Run 'claude plugin marketplace update' to refresh metadata
#     - Check plugin name format: plugin-name@marketplace-name
#     - Verify marketplace is registered: claude plugin marketplace list
#
#   Marketplace unreachable:
#     - Check internet connection
#     - Try: claude plugin marketplace update
#     - Clear cache: rm -rf ~/.claude/plugins/cache
#
#   Permission errors:
#     - Plugins install to ~/.claude/plugins/ (user writable)
#     - Check disk space and permissions on ~/.claude
#
################################################################################

set -euo pipefail

# shellcheck source=lib.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/lib.sh"

# Main function
main() {
    log "Installing Claude Code plugins..."

    # Check if claude CLI is available
    if ! command -v claude &> /dev/null; then
        warn "claude CLI not found. Skipping plugin installation"
        warn "Install Claude Code first, then run: $0"
        return
    fi

    log "Claude version: $(claude --version)"

    # Update marketplace metadata first
    if [[ $DRY_RUN == false ]]; then
        log "Updating plugin marketplace metadata..."
        claude plugin marketplace update >/dev/null 2>&1 || warn "Failed to update marketplace"
    fi

    # Parse plugins from YAML using yq
    local plugins
    plugins=$(yq eval '.packages.claude.plugins[]' "$CONFIG_FILE" 2>/dev/null | tr -d '"')

    local installed=0
    local failed=0
    local total=0

    while IFS= read -r plugin; do
        if [[ -n "$plugin" ]]; then
            total=$((total + 1))
            if [[ $DRY_RUN == true ]]; then
                log "[DRY RUN] Would install Claude plugin: $plugin"
            else
                log "Installing Claude plugin: $plugin"
                if claude plugin install "$plugin" --scope user 2>&1 | grep -q "Successfully installed"; then
                    installed=$((installed + 1))
                    success "  ✓ $plugin installed"
                else
                    failed=$((failed + 1))
                    error "  ✗ $plugin failed to install"
                fi
            fi
        fi
    done <<< "$plugins"

    if [[ $DRY_RUN == false ]]; then
        if [[ $failed -gt 0 ]]; then
            warn "Claude plugins: $installed/$total installed, $failed failed"
        else
            success "Claude plugins: $installed/$total installed"
        fi
    else
        success "Claude plugins checked: $total plugins would be installed"
    fi
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
