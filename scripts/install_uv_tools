#!/bin/bash
################################################################################
# Install UV Tools
#
# DESCRIPTION:
#   Installs Python tools using uv (fast Python package installer).
#   Reads tool list from dotfiles.yaml and installs them using 'uv tool install'.
#
# USAGE:
#   Called by install.sh, or run directly:
#   ./install_uv_tools
#
# ENVIRONMENT VARIABLES:
#   DRY_RUN  - If true, preview changes without making them (default: false)
#   VERBOSE  - If true, show detailed output (default: false)
#
# WHAT IT DOES:
#   1. Checks if uv is installed, skips if not found
#   2. Reads tool packages from packages.uv.tool_packages in dotfiles.yaml
#   3. Installs each tool using 'uv tool install <name> --from <source>'
#   4. Reports statistics on tools installed
#
# DEPENDENCIES:
#   - uv (skips if not installed; install with: brew install uv)
#   - yq (for parsing YAML)
#   - dotfiles.yaml configuration file
#
# NOTES:
#   uv is much faster than pip for installing Python packages.
#   Typically used for MCP servers and other Python CLI tools.
#
################################################################################

set -euo pipefail

# shellcheck source=lib.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/lib.sh"

# Main function
main() {
    log "Installing uv tools..."

    # Check if uv is available
    if ! command -v uv &> /dev/null; then
        warn "uv not found. Skipping uv tool installation"
        warn "Install uv first (brew install uv), then run: $0"
        return
    fi

    log "uv version: $(uv --version)"

    # Parse uv tool packages from YAML using yq
    local tool_count
    tool_count=$(yq eval '.packages.uv.tool_packages | length' "$CONFIG_FILE" 2>/dev/null || echo "0")

    if [[ "$tool_count" == "0" ]]; then
        log "No uv tools to install"
        return
    fi

    local installed=0
    local total=0

    for ((i=0; i<tool_count; i++)); do
        local name
        local source
        name=$(yq eval ".packages.uv.tool_packages[$i].name" "$CONFIG_FILE" 2>/dev/null)
        source=$(yq eval ".packages.uv.tool_packages[$i].source" "$CONFIG_FILE" 2>/dev/null)

        if [[ -n "$name" && -n "$source" ]]; then
            total=$((total + 1))
            if [[ $DRY_RUN == true ]]; then
                log "[DRY RUN] Would install uv tool: $name from $source"
            else
                log "Installing uv tool: $name from $source"
                if uv tool install "$name" --from "$source"; then
                    installed=$((installed + 1))
                    success "  ✓ $name installed"
                else
                    warn "  ✗ Failed to install $name"
                fi
            fi
        fi
    done

    if [[ $DRY_RUN == false ]]; then
        success "uv tools installed: $installed/$total tools"
    else
        success "uv tools checked: $total tools would be installed"
    fi
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
